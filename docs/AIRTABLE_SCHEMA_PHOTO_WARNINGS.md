# Airtable Schema: No Photo Warnings Table

This document defines the schema for the "No Photo Warnings" table used in Epic 4: Profile Photo Enforcement.

## Table Overview

**Table Name**: `No Photo Warnings`

**Purpose**: Track warning count and enforcement history for members without profile photos

**Base**: Existing BOCC Airtable base (same as `attendees` and `checkins` tables)

**Primary Use**: Weekly enforcement function queries this table to determine warning level for each member in "No Profile Photo" segment

---

## Field Definitions

### 1. `id` (Autonumber)
- **Type**: Autonumber
- **Purpose**: Primary key, unique identifier for each warning record
- **Configuration**: Auto-generated by Airtable, starts at 1
- **Indexed**: Yes (automatic)
- **Example**: `1`, `2`, `3`, `...`

---

### 2. `Name` (Text)
- **Type**: Single line text
- **Purpose**: Member's full display name from Circle.so profile
- **Required**: Yes
- **Max Length**: 255 characters
- **Indexed**: No
- **Example**: `"John Smith"`, `"Jane Doe"`, `"Test Glick"`

**Data Source**: `member.name` from Circle.so API response

**Validation**: None (accepts any valid Circle member name)

**Notes**:
- This is for human readability in Airtable views
- May differ from email username
- Can be updated if member changes their Circle display name

---

### 3. `Email` (Email)
- **Type**: Email
- **Purpose**: Member's email address (unique identifier for lookups)
- **Required**: Yes
- **Format**: Valid email address (validated by Airtable)
- **Indexed**: Yes (for fast lookups)
- **Example**: `"john@example.com"`, `"zglicka@gmail.com"`

**Data Source**: `member.email` from Circle.so API response

**Validation**: Must be valid email format (Airtable enforces)

**Notes**:
- **Primary lookup key** for enforcement function
- Should be unique per member (one record per email)
- Case-insensitive for lookups (normalize to lowercase in queries)

**Query Pattern**:
```javascript
const records = await base('No Photo Warnings').select({
  filterByFormula: `LOWER({Email}) = LOWER("${email}")`
}).firstPage();
```

---

### 4. `Number of Warnings` (Number)
- **Type**: Number (integer)
- **Purpose**: Current warning count for this member
- **Required**: Yes
- **Default Value**: `1` (when record created after first warning)
- **Min Value**: `0` (when member adds photo, before record deletion)
- **Max Value**: `5` (deactivation occurs at 5)
- **Precision**: 0 decimal places (integer only)
- **Format**: `1`, `2`, `3`, `4`, `5`

**Lifecycle**:
- **Created**: Set to `1` when member first appears in "No Profile Photo" segment
- **Incremented**: +1 each week member remains without photo (up to max 5)
- **Reset**: Set to `0` if member is re-invited after deactivation
- **Deleted**: Record deleted when member adds photo (status = "Photo Added")

**Warning Level Logic**:
- `1`, `2`, `3` → Standard warning message
- `4` → Final warning message + admin alert
- `5` → Deactivation + deactivation notice + admin alert

---

### 5. `Last Warning Date` (Date)
- **Type**: Date (date only, no time)
- **Purpose**: Track when last warning was sent
- **Required**: Yes
- **Format**: `YYYY-MM-DD` (e.g., `2025-02-05`)
- **Timezone**: UTC

**Data Source**: `new Date().toISOString().split('T')[0]` (current date when warning sent)

**Usage**:
- Helps debug enforcement runs ("When did this member last receive a warning?")
- Could be used for future features (e.g., decay warning count if photo added within X days)
- Provides audit trail

**Update Pattern**:
- Updated every time warning count increments
- Updated when status changes

---

### 6. `Status` (Single Select)
- **Type**: Single select (dropdown)
- **Purpose**: Track current enforcement status for this member
- **Required**: Yes
- **Default Value**: `"Active"` (when record created)
- **Options**:
  - `"Active"` - Member currently without photo, warnings in progress
  - `"Photo Added"` - Member added photo, enforcement stopped (record should be deleted soon)
  - `"Deactivated"` - Member's account was deactivated after 5 warnings

**Color Coding** (suggested):
- `"Active"` → Yellow (neutral, ongoing)
- `"Photo Added"` → Green (success, resolved)
- `"Deactivated"` → Red (action taken)

**Status Transitions**:
```
[New member in segment]
         ↓
    "Active" (Warning 1)
         ↓
    "Active" (Warning 2, 3, 4)
         ↓
         ├─→ "Photo Added" → Record deleted
         │
         └─→ "Deactivated" (Warning 5)
                  ↓
             (Manual re-invite)
                  ↓
             Record deleted or reset to "Active" with count=0
```

**Enforcement Logic**:
- **Active**: Continue sending warnings, incrementing count
- **Photo Added**: Send thank-you message, delete record
- **Deactivated**: No further action, record kept for audit trail

---

### 7. `Created` (Created Time)
- **Type**: Created time
- **Purpose**: Auto-populated timestamp when record first created
- **Configuration**: Automatic (Airtable system field)
- **Format**: ISO 8601 datetime (e.g., `2025-02-05T14:30:00.000Z`)
- **Timezone**: UTC
- **Indexed**: No

**Usage**:
- Audit trail: "When was this member first flagged for no photo?"
- Analytics: "How long do members typically take to add photos?"
- Debugging: Identify old records that may be stale

**Notes**:
- Cannot be manually edited
- Set once when record created, never changes

---

### 8. `Circle Member ID` (Text) - Optional Enhancement
- **Type**: Single line text
- **Purpose**: Store Circle.so member ID for direct linking
- **Required**: No (optional field for Phase 2)
- **Format**: Circle member UUID (e.g., `"a594d38f"`, `"73e5a590"`)
- **Example**: `"a594d38f"` (Test Glick's Circle ID)

**Usage**:
- Construct direct links: `https://www.716.social/u/{Circle Member ID}`
- Avoid email-based lookups when Circle ID is more reliable
- Cross-reference with Circle API responses

**Note**: Not required for MVP, but recommended for Phase 2 to improve reliability

---

## Table Views

### Default View: "Active Warnings"
**Purpose**: See all members currently in enforcement process

**Filter**: `{Status} = "Active"`

**Sort**: `{Number of Warnings}` (descending) → Show members closest to deactivation first

**Fields Shown**:
- Name
- Email
- Number of Warnings
- Last Warning Date
- Status

---

### View: "Final Warnings" (Admin Priority)
**Purpose**: Quickly see members about to be deactivated

**Filter**: `AND({Status} = "Active", {Number of Warnings} >= 4)`

**Sort**: `{Number of Warnings}` (descending)

**Color Coding**: Red background for urgency

**Fields Shown**:
- Name
- Email
- Number of Warnings (should be 4 or 5)
- Last Warning Date
- Status

---

### View: "Deactivated History"
**Purpose**: Audit trail of all deactivated members

**Filter**: `{Status} = "Deactivated"`

**Sort**: `{Last Warning Date}` (descending) → Most recent deactivations first

**Fields Shown**:
- All fields (full audit trail)

---

### View: "Recently Resolved"
**Purpose**: See members who added photos (before records deleted)

**Filter**: `{Status} = "Photo Added"`

**Sort**: `{Last Warning Date}` (descending)

**Note**: Records with this status should be automatically deleted after thank-you message sent, so this view will typically be empty unless there's a processing delay

---

## Sample Data

| id | Name | Email | Number of Warnings | Last Warning Date | Status | Created |
|----|------|-------|-------------------|-------------------|--------|---------|
| 1 | Test Glick | zglicka@gmail.com | 1 | 2025-02-03 | Active | 2025-02-03T09:00:00.000Z |
| 2 | John Smith | john@example.com | 4 | 2025-01-27 | Active | 2025-01-06T09:00:00.000Z |
| 3 | Jane Doe | jane@example.com | 5 | 2025-02-03 | Deactivated | 2025-01-06T09:00:00.000Z |
| 4 | Bob Wilson | bob@example.com | 2 | 2025-01-27 | Photo Added | 2025-01-20T09:00:00.000Z |

**Explanation**:
- **Test Glick**: Just received first warning on Feb 3, currently active
- **John Smith**: Has received 4 warnings over 4 weeks, on final warning (admin should be notified)
- **Jane Doe**: Reached 5 warnings, account deactivated on Feb 3
- **Bob Wilson**: Received 2 warnings, then added photo on Jan 27 (record will be deleted after thank-you message)

---

## API Operations

### Create New Warning Record
```javascript
const base = new Airtable({apiKey: process.env.AIRTABLE_API_KEY}).base(process.env.AIRTABLE_BASE_ID);

const record = await base('No Photo Warnings').create({
  'Name': memberName,
  'Email': memberEmail.toLowerCase(),
  'Number of Warnings': 1,
  'Last Warning Date': new Date().toISOString().split('T')[0],
  'Status': 'Active'
});

console.log('Created warning record:', record.id);
```

---

### Find Existing Record by Email
```javascript
const records = await base('No Photo Warnings').select({
  filterByFormula: `LOWER({Email}) = LOWER("${email}")`
}).firstPage();

const existingRecord = records.length > 0 ? records[0] : null;
```

---

### Increment Warning Count
```javascript
const newCount = existingRecord.fields['Number of Warnings'] + 1;
const today = new Date().toISOString().split('T')[0];

await base('No Photo Warnings').update(existingRecord.id, {
  'Number of Warnings': newCount,
  'Last Warning Date': today
});
```

---

### Mark as Deactivated
```javascript
await base('No Photo Warnings').update(existingRecord.id, {
  'Status': 'Deactivated',
  'Last Warning Date': today
});
```

---

### Mark as Photo Added (then delete)
```javascript
// Optional: Mark status before deleting for logging
await base('No Photo Warnings').update(existingRecord.id, {
  'Status': 'Photo Added',
  'Last Warning Date': today
});

// Send thank-you message here

// Delete record (no longer needed)
await base('No Photo Warnings').destroy(existingRecord.id);
```

---

## Data Retention Policy

**Active Records**: Kept indefinitely while `Status = "Active"`

**Photo Added**: Deleted immediately after thank-you message sent (no retention needed)

**Deactivated**: Kept for audit trail (recommend 90-day retention, then archive or delete)

**Future Enhancement**: Add `Archived` status and automated archival after 90 days

---

## Security Considerations

1. **PII Handling**: This table stores email addresses (PII). Ensure Airtable workspace has appropriate access controls.

2. **Access Control**:
   - Editors: Netlify function (via API key) + Admin users
   - Viewers: Admin team only
   - Public: No access

3. **API Key Security**: `AIRTABLE_API_KEY` must have write access to this table but should follow least-privilege principle (no access to unrelated bases)

4. **Email Normalization**: Always use lowercase emails for consistency in queries to prevent duplicate records (e.g., `John@Example.com` vs `john@example.com`)

---

## Testing Checklist

- [ ] Create table in Airtable with exact field names and types as specified
- [ ] Test record creation via API with all required fields
- [ ] Test email lookup (case-insensitive) with existing and non-existent emails
- [ ] Test warning count increment (1 → 2 → 3 → 4 → 5)
- [ ] Test status transitions (Active → Photo Added, Active → Deactivated)
- [ ] Verify "Active Warnings" view filters correctly
- [ ] Verify "Final Warnings" view shows only count >= 4
- [ ] Test record deletion after "Photo Added"
- [ ] Create sample data with Test Glick user
- [ ] Verify all views display data as expected

---

## Migration Notes

**From**: None (new table)

**To**: Airtable base: `{AIRTABLE_BASE_ID}`

**Manual Setup Required**:
1. Create table named exactly `No Photo Warnings`
2. Add fields in order specified above
3. Configure field types precisely (especially Email, Number, Date, Single Select)
4. Set default values where specified
5. Create views as documented
6. Verify API key has write permissions to this table
7. Test with sample data before production use

---

**Document Status**: READY FOR IMPLEMENTATION
**Last Updated**: 2025-02-05
**Epic**: EPIC-4 Profile Photo Enforcement
**Owner**: Admin (manual Airtable setup required)
